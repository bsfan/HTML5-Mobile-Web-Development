<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Content-Language" content="en"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Tweetstr</title>
    <link rel="apple-touch-icon" href="../../../shared/images/tweetstr-icon.png"/>
    <link rel="stylesheet" href="html5reset.css" type="text/css" media="screen" charset="utf-8">
    <link rel="stylesheet" href="style.css" type="text/css" media="screen" charset="utf-8">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js" type="text/javascript"></script>
    <script src='script.js' charset="utf-8"></script>
		<script type="text/javascript">
		jQuery(function($){
		  pageLoaded();
		});
		var map = null;
		
		function pageLoaded() {
			addEventListeners();
			orientationChanged();
		}
		
		function addEventListeners() {
			// Orientation Detection
			var supportsOrientationChange = "onorientationchange" in window;
			var orientationEvent = supportsOrientationChange ? "orientationchange" : "resize";

			window.addEventListener(orientationEvent, orientationChanged, false);
		}
		
		function orientationChanged() {
			var header = document.getElementsByTagName('header')[0];
				
			if ((window.orientation == 90) ||
				(window.orientation == -90)) {
				navigator.geolocation.getCurrentPosition(loadMap, function(error) {
					// Handle Error
					console.log(error.message);
				});
				header.innerText = 'Map View';
			}
			else {
				getTweets();
				header.innerText = 'Tweetstr';
			}
		}
		
		function loadMap(position) {
			var latLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
			
			var myOptions = {
				center: latLng,
				zoom: 8,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			map = new google.maps.Map(document.getElementById('mapCanvas'), myOptions);
			
			loadLocalTweets(position);
		}
		
		function loadLocalTweets(position) {
			var client = new XMLHttpRequest();
			client.onreadystatechange = function() {
				if (this.readyState == this.DONE && this.status == 200) {
					var response = eval('(' + this.responseText + ')');
					var re = new RegExp('-?\\d+\\.\\d+\\,-?\\d+\\.\\d+');
					
					for (var resultId in response.results) {
						var result = response.results[resultId];
						
						var m = re.exec(result.location);
						if ((m) && (m.length > 0)) {
							var latLng = m[0].split(',');
							var location = new google.maps.LatLng(latLng[0], latLng[1]);
							try {
								var mark = new google.maps.Marker({
									position: location,
									map: map
								});
							}
							catch (ex) {
								console.log(ex);
							}
						}
					}
				}
			};
			var apiCall = 'http://search.twitter.com/search.json?rpp=100&geocode=' + position.coords.latitude + ',' + position.coords.longitude + ',25mi';
			var requestString = '../../../shared/scripts/curl.php?apiCall=' + escape(apiCall);
			
			client.open('GET', requestString, true);
			client.send();				
		}
	</script>
  </head>
</html>
  <body>
    <header>Tweetstr</header>
    <nav>
      <ul id='navList'>
        <li><a id='liHome' href="#home">Home</a></li>
        <li><a id='liMentions' href="#mentions">Mentions</a></li>
        <li><a id='liFaves' href="#favorites">Favorites</a></li>
        <li><a id='liMessages' href="#messages">Messages</a></li>
        <li><a id='liSearch' href="#search">Search</a></li>
      </ul>
    </nav>
    <section id='home' class='selected'>
      <ul id='tweetsList' class='tweets'></ul>
    </section>
    <section id='profile' class=''></section>
    <section id="mentions">Mentions</section>
    <section id="favorites">Favorites</section>
    <section id="messages">Messages</section>
    <section id="search">Search</section>
    
    <section id='map' class=''>
			<div id='mapCanvas'>Add map here!</div>
		</section>
		
  </body>
</html>
